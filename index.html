<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mobile AprilTag Detector (AprilTagWasm é€‚é…ç‰ˆ)</title>
  <style>
    :root{--bg:#0b0f14;--fg:#e6eef7;--muted:#9fb3c8;--accent:#3da9fc}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:#121924;border-bottom:1px solid #1b2430;z-index:10}
    header .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;padding:.6rem .75rem}
    button,input,select{background:#0e141d;color:var(--fg);border:1px solid #243242;border-radius:10px;padding:.45rem .6rem}
    button{font-weight:600}
    button:disabled{opacity:.55}
    main{position:relative}
    #video{width:100%;height:100%;object-fit:cover;display:block;background:#000}
    #overlay{position:absolute;inset:0;display:block}
    #msgs{padding:.5rem .75rem;color:var(--muted);border-top:1px solid #1b2430}
    #diag{padding:.5rem .75rem;color:#f4bf4f;word-break:break-all;border-top:1px dashed #2a3546}
  </style>
</head>
<body>
<header>
  <div class="row">
    <button id="startBtn">â–¶ å¼€å§‹</button>
    <button id="stopBtn" disabled>â¹ åœæ­¢</button>
    <button id="switchBtn">ğŸ”„ åˆ‡æ¢å‰/åæ‘„</button>
    <label>é»˜è®¤Tagå°ºå¯¸(m)
      <input id="tagSize" type="number" step="0.001" min="0.01" value="0.05" style="width:7ch">
    </label>
    <label>FOV(Â°)
      <input id="fov" type="number" step="1" min="30" max="100" value="60" style="width:5ch">
    </label>
    <label>åˆ†è¾¨ç‡
      <select id="res">
        <option value="1280x720">1280Ã—720</option>
        <option value="1920x1080">1920Ã—1080</option>
        <option value="640x480">640Ã—480</option>
      </select>
    </label>
    <label><input id="showPose" type="checkbox" checked> æ˜¾ç¤ºå§¿æ€è½´</label>
    <label><input id="showIds" type="checkbox" checked> æ˜¾ç¤ºID</label>
  </div>
</header>

<main>
  <video id="video" playsinline muted></video>
  <canvas id="overlay"></canvas>
</main>

<div id="msgs">å‡†å¤‡ä¸­â€¦</div>
<div id="diag"></div>

<!-- å…³é”®ï¼šç¡®ä¿ .wasm ä¸æœ¬é¡µåŒç›®å½•æ—¶å¯ä»¥è¢«å®šä½ -->
<script>
  window.Module = window.Module || {};
  Module.locateFile = Module.locateFile || function(path){
    const base = location.href.replace(/[#?].*$/,'').replace(/[^\/]*$/,'');
    return base + path;
  };
</script>
<script defer src="./apriltag_wasm.js"></script>
<script>
(function(){
  const els = {
    start: startBtn, stop: stopBtn, switch: switchBtn,
    video: video, overlay: overlay,
    tagSize: tagSize, fov: fov, res: res,
    showPose: showPose, showIds: showIds,
    msgs: msgs, diag: diag
  };

  let detector = null;      // æœŸæœ›æ˜¯ { detect(), set_camera_info(), set_tag_size(), ... }
  let mod = null;           // åŸå§‹ Emscripten æ¨¡å—ï¼ˆå¦‚æœåªæœ‰ä½å±‚å¯¼å‡ºï¼‰
  let stream = null;
  let running = false;
  let facing = 'environment';

  const seenSizes = new Map();

  function log(t){ els.msgs.textContent = t; }
  function diag(t){ els.diag.innerHTML = t; }

  // --- åˆå§‹åŒ– (ä¼˜å…ˆé€‚é…ä½ ç°åœ¨çš„ AprilTagWasm) ---
  async function initDetector(){
    // æ‰“å°å¯ç–‘å…¨å±€ç¬¦å·ï¼Œä¾¿äºè¯Šæ–­
    const keys = Object.keys(window).filter(k=>/(April|apriltag|create)/i.test(k)).sort();
    diag(`<b>å…¨å±€ç¬¦å·:</b> ${keys.join(', ') || '(æ— )'}<br>`);

    // 1) ç›´æ¥æ”¯æŒ Apriltag()
    if(typeof window.Apriltag === 'function'){
      return new Promise((resolve,reject)=>{
        try{
          detector = Apriltag(()=>{
            diag(els.diag.innerHTML + 'ä½¿ç”¨ <b>Apriltag()</b> åˆå§‹åŒ–æˆåŠŸ<br>');
            resolve();
          });
        }catch(e){ reject(e); }
      });
    }

    // 2) ç›´æ¥æ”¯æŒ createApriltagDetector()
    if(typeof window.createApriltagDetector === 'function'){
      detector = await window.createApriltagDetector();
      diag(els.diag.innerHTML + 'ä½¿ç”¨ <b>createApriltagDetector()</b> åˆå§‹åŒ–æˆåŠŸ<br>');
      return;
    }

    // 3) é€‚é…ä½ å½“å‰çš„ AprilTagWasmï¼ˆå¤§æ¦‚ç‡æ˜¯ MODULARIZE=1 çš„ Emscripten å·¥å‚ï¼‰
    if(typeof window.AprilTagWasm === 'function'){
      let ret = null;
      try{
        ret = window.AprilTagWasm(); // å¯èƒ½è¿”å› thenable / Promise
      }catch(e){
        // æœ‰äº›æ„å»ºè¦æ±‚ä¼ å…¥é…ç½®å¯¹è±¡ï¼šAprilTagWasm({ locateFile: ... })
        ret = window.AprilTagWasm({ locateFile: Module.locateFile });
      }
      mod = (typeof ret?.then === 'function') ? await ret : ret;
      if(!mod) throw new Error('AprilTagWasm() æœªè¿”å›æ¨¡å—');

      // å°è¯•æŸ¥æ‰¾â€œé«˜å±‚å°è£…â€çš„ detectorï¼ˆä¸åŒæ„å»ºå¯èƒ½æŠŠå®ƒæŒ‚åœ¨æ¨¡å—ä¸Šï¼‰
      // å¸¸è§å‘½åï¼šmod.Apriltag / mod.createApriltagDetector / mod.detector / mod.default
      const candidateNames = ['Apriltag','createApriltagDetector','detector','default'];
      for(const name of candidateNames){
        if(typeof mod[name] === 'function'){
          // å°è¯•ä¸¤ç§å·¥å‚æ¨¡å¼ï¼šcallback æˆ– promise
          try{
            const r = mod[name](( )=>{});
            detector = (typeof r?.then === 'function') ? await r : r;
          }catch(_){}
          if(!detector && typeof mod[name] === 'function'){
            try{ detector = await mod[name](); }catch(_){}
          }
        }
      }

      if(detector){
        diag(els.diag.innerHTML + 'é€šè¿‡ <b>AprilTagWasm()</b> æ‰¾åˆ°é«˜å±‚ detector<br>');
        return;
      }

      // è‹¥æ²¡æœ‰é«˜å±‚å°è£…ï¼Œæ‰“å°æ¨¡å—å¯¼å‡ºï¼Œç­‰å¾…æˆ‘ä¸‹ä¸€æ­¥ç»™ä½ å†™ cwrap é€‚é…
      const modKeys = Object.keys(mod).sort();
      diag(els.diag.innerHTML +
        `<div style="margin-top:.5rem"><b>AprilTagWasm æ¨¡å—å¯ç”¨é”®å (${modKeys.length})ï¼š</b><br><code>${modKeys.join(', ')}</code></div>` +
        `<div style="margin-top:.5rem;color:#ffdda6">æœªå‘ç°ç°æˆçš„é«˜çº§ detect() å°è£…ã€‚æˆ‘å¯ä»¥æ ¹æ®ä½ è¿™ä»½é”®åæ¸…å•ï¼Œä¸ºä½ å†™ä¸€ä¸ªåŸºäº <code>mod.cwrap</code> çš„é€‚é…å±‚ï¼ˆéœ€è¦å¯¼å‡ºå‡½æ•°åï¼Œä¾‹å¦‚ <code>_detect</code> / <code>_init</code> / <code>_free</code> ç­‰ï¼‰ã€‚æŠŠè¿™æ®µâ€œé”®åæ¸…å•â€å‘ç»™æˆ‘å³å¯ã€‚</div>`
      );
      throw new Error('æœªæ‰¾åˆ° Apriltag å·¥å‚å‡½æ•° (Apriltag/createApriltagDetector)ï¼Œä¸” AprilTagWasm æœªæš´éœ²é«˜çº§å°è£…');
    }

    throw new Error('æœªæ‰¾åˆ° Apriltag å·¥å‚å‡½æ•° (Apriltag/createApriltagDetector/AprilTagWasm)');
  }

  // --- æ‘„åƒå¤´ ---
  async function openCamera(){
    const [w,h] = els.res.value.split('x').map(Number);
    const constraints = { video:{ facingMode:{ideal:facing}, width:{ideal:w}, height:{ideal:h} }, audio:false };
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    els.video.srcObject = stream;
    await els.video.play();
  }

  // --- (å ä½) æ£€æµ‹å¾ªç¯ï¼šåªæœ‰åœ¨ detector å…·å¤‡ detect() æ—¶æ‰å¯åŠ¨ ---
  async function detectLoop(){
    if(!running) return;
    if(!detector || typeof detector.detect !== 'function'){
      log('æ£€æµ‹å™¨æœªæä¾› detect()ã€‚è¯·æŠŠé¡µé¢åº•éƒ¨â€œAprilTagWasm æ¨¡å—å¯ç”¨é”®åâ€å‘æˆ‘ï¼Œæˆ‘ç»™ä½ å†™é€‚é…ã€‚');
      return;
    }

    try{
      const vw = els.video.videoWidth, vh = els.video.videoHeight;
      if(!vw || !vh){ requestAnimationFrame(detectLoop); return; }

      // æŠ“å¸§å¹¶è½¬ç°åº¦
      const off = detectLoop._off || (detectLoop._off = document.createElement('canvas'));
      if(off.width!==vw){ off.width=vw; off.height=vh; }
      const octx = off.getContext('2d', {willReadFrequently:true});
      octx.drawImage(els.video,0,0,vw,vh);
      const {data} = octx.getImageData(0,0,vw,vh);
      let gray = detectLoop._gray;
      if(!gray || gray.length!==vw*vh) gray = detectLoop._gray = new Uint8Array(vw*vh);
      for(let i=0,j=0;i<data.length;i+=4,++j){ gray[j]=(data[i]*.299+data[i+1]*.587+data[i+2]*.114)|0; }

      // ç›¸æœºå†…å‚
      const fov = (+els.fov.value||60)*Math.PI/180;
      const fx = 0.5*vw/Math.tan(0.5*fov), fy = fx, cx=vw/2, cy=vh/2;
      if(typeof detector.set_camera_info === 'function'){ detector.set_camera_info(fx,fy,cx,cy); }

      // è¿è¡Œæ£€æµ‹ï¼ˆé«˜å±‚å°è£…æœŸæœ›ï¼šdetect(gray, w, h)ï¼‰
      const detections = await detector.detect(gray, vw, vh);

      // Tag å°ºåº¦
      const defSize = parseFloat(els.tagSize.value)||0.05;
      if(typeof detector.set_tag_size === 'function'){
        for(const d of detections){ if(!seenSizes.has(d.id)){ detector.set_tag_size(d.id, defSize); seenSizes.set(d.id, defSize); } }
      }

      // ç”»æ¡†ï¼ˆç®€åŒ–ï¼‰
      drawOverlay(detections);
      requestAnimationFrame(detectLoop);
    }catch(e){
      log('æ£€æµ‹å‡ºé”™ï¼š' + e.message);
      console.error(e);
    }
  }

  function drawOverlay(detections=[]){
    const ctx = els.overlay.getContext('2d');
    const rect = els.video.getBoundingClientRect();
    const scale = devicePixelRatio;
    const w = Math.max(1, Math.round(rect.width*scale));
    const h = Math.max(1, Math.round(rect.height*scale));
    if(els.overlay.width!==w || els.overlay.height!==h){ els.overlay.width=w; els.overlay.height=h; }
    ctx.clearRect(0,0,w,h);
    ctx.lineWidth=3; ctx.strokeStyle='rgba(61,169,252,.95)'; ctx.fillStyle='rgba(230,238,247,.95)'; ctx.font=`${14*scale}px system-ui`;
    for(const d of detections){
      if(!d?.corners) continue;
      const c = d.corners.map(k=>({x:k.x*scale,y:k.y*scale}));
      ctx.beginPath(); ctx.moveTo(c[0].x,c[0].y); for(let i=1;i<c.length;i++) ctx.lineTo(c[i].x,c[i].y); ctx.closePath(); ctx.stroke();
      if(els.showIds.checked){ ctx.fillText(`ID:${d.id}`, c[0].x+6, c[0].y+6); }
    }
    log(`æ£€æµ‹æ•°: ${detections.length}`);
  }

  // --- äº‹ä»¶ ---
  els.start.addEventListener('click', async ()=>{
    try{
      els.start.disabled = true;
      await initDetector();
      await openCamera();
      running = true;
      log('æ‘„åƒå¤´å·²å¼€å¯ï¼Œæ£€æµ‹å™¨å·²å°±ç»ª');
      requestAnimationFrame(detectLoop);
    }catch(err){
      log('æ— æ³•å¼€å¯ï¼š' + err.message + 'ï¼ˆè¯·ç¡®è®¤ä½¿ç”¨ HTTPS ä¸”å·²æˆæƒç›¸æœºï¼‰');
      els.start.disabled = false;
    }
  });

  els.stop.addEventListener('click', ()=>{
    running = false;
    els.stop.disabled = true;
    if(stream) stream.getTracks().forEach(t=>t.stop());
    log('å·²åœæ­¢');
    els.start.disabled = false;
  });

  els.switch.addEventListener('click', async ()=>{
    facing = (facing==='environment' ? 'user' : 'environment');
    if(running){ await openCamera(); }
  });

  window.addEventListener('resize', ()=>{
    const rect = els.video.getBoundingClientRect();
    els.overlay.width = Math.round(rect.width * devicePixelRatio);
    els.overlay.height = Math.round(rect.height * devicePixelRatio);
  });
})();
</script>
</body>
</html>
