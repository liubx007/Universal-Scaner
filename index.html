<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AprilTag on Mobile (CDN版)</title>
  <style>
    body{margin:0;background:#0b0f14;color:#e6eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:#121924;border-bottom:1px solid #1b2430;z-index:10}
    header .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;padding:.6rem .75rem}
    button,input,select{background:#0e141d;color:#e6eef7;border:1px solid #243242;border-radius:10px;padding:.45rem .6rem}
    main{position:relative}
    #video{width:100%;height:100%;object-fit:cover;display:block;background:#000}
    #overlay{position:absolute;inset:0;display:block}
    #msgs{padding:.5rem .75rem;color:#9fb3c8;border-top:1px solid #1b2430}
  </style>
</head>
<body>
<header>
  <div class="row">
    <button id="startBtn">▶ 开始</button>
    <button id="stopBtn" disabled>⏹ 停止</button>
    <label>FOV(°)<input id="fov" type="number" step="1" value="60" style="width:5ch"></label>
    <label>分辨率
      <select id="res">
        <option value="1280x720">1280×720</option>
        <option value="1920x1080">1920×1080</option>
        <option value="640x480">640×480</option>
      </select>
    </label>
    <label>默认Tag尺寸(m)<input id="tagSize" type="number" step="0.001" value="0.05" style="width:7ch"></label>
    <label><input id="showIds" type="checkbox" checked> 显示ID</label>
  </div>
</header>

<main>
  <video id="video" playsinline muted></video>
  <canvas id="overlay"></canvas>
</main>
<div id="msgs">准备中…</div>

<!-- 关键：把 wasm 指到远程文件 -->
<script>
  window.Module = window.Module || {};
  Module.locateFile = function(path){
    if(path.endsWith('.wasm')){
      return 'https://raw.githubusercontent.com/arenaxr/apriltag-js-standalone/master/html/apriltag_wasm.wasm';
    }
    return path;
  };
</script>
<!-- 使用已知可用的 apriltag wasm js（公开仓库） -->
<script defer src="https://raw.githubusercontent.com/arenaxr/apriltag-js-standalone/master/html/apriltag_wasm.js"></script>

<script>
(function(){
  const els = {
    start: document.getElementById('startBtn'),
    stop: document.getElementById('stopBtn'),
    video: document.getElementById('video'),
    overlay: document.getElementById('overlay'),
    fov: document.getElementById('fov'),
    res: document.getElementById('res'),
    tagSize: document.getElementById('tagSize'),
    showIds: document.getElementById('showIds'),
    msgs: document.getElementById('msgs'),
  };

  let detector=null, stream=null, running=false;

  function msg(t){ els.msgs.textContent=t; }

  async function initDetector(){
    return new Promise((resolve,reject)=>{
      if(typeof window.Apriltag!=='function'){
        reject(new Error('Apriltag 未加载（检查网络或被拦截）')); return;
      }
      try{
        detector = Apriltag(()=>{
          try{
            detector.set_max_detections?.(0);
            detector.set_return_pose?.(1);
            detector.set_return_solutions?.(0);
          }catch(e){}
          resolve();
        });
      }catch(e){ reject(e); }
    });
  }

  async function openCamera(){
    const [w,h]=els.res.value.split('x').map(Number);
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:w},height:{ideal:h},facingMode:{ideal:'environment'}},audio:false});
    els.video.srcObject=stream; await els.video.play();
  }

  function draw(dets=[]){
    const ctx=els.overlay.getContext('2d');
    const r=els.video.getBoundingClientRect(), s=devicePixelRatio||1;
    const W=Math.max(1,Math.round(r.width*s)), H=Math.max(1,Math.round(r.height*s));
    if(els.overlay.width!==W||els.overlay.height!==H){ els.overlay.width=W; els.overlay.height=H; }
    ctx.clearRect(0,0,W,H);
    ctx.lineWidth=3; ctx.strokeStyle='rgba(61,169,252,.95)'; ctx.fillStyle='rgba(230,238,247,.95)'; ctx.font=`${14*s}px system-ui`;
    for(const d of dets){
      if(!d?.corners) continue;
      const c=d.corners.map(k=>({x:k.x*s,y:k.y*s}));
      ctx.beginPath(); ctx.moveTo(c[0].x,c[0].y); for(let i=1;i<c.length;i++) ctx.lineTo(c[i].x,c[i].y); ctx.closePath(); ctx.stroke();
      if(els.showIds.checked){ ctx.fillText(`ID:${d.id}`, c[0].x+6, c[0].y+6); }
    }
    msg(`检测数: ${dets.length}`);
  }

  async function loop(){
    if(!running) return;
    const vw=els.video.videoWidth, vh=els.video.videoHeight;
    if(!vw||!vh){ requestAnimationFrame(loop); return; }

    // 抓帧->灰度
    const off = loop._off || (loop._off=document.createElement('canvas'));
    if(off.width!==vw){ off.width=vw; off.height=vh; }
    const octx=off.getContext('2d',{willReadFrequently:true});
    octx.drawImage(els.video,0,0,vw,vh);
    const {data}=octx.getImageData(0,0,vw,vh);
    let gray=loop._gray; if(!gray||gray.length!==vw*vh) gray=loop._gray=new Uint8Array(vw*vh);
    for(let i=0,j=0;i<data.length;i+=4,++j){ gray[j]=(data[i]*.299+data[i+1]*.587+data[i+2]*.114)|0; }

    // 相机内参近似
    const fov=(+els.fov.value||60)*Math.PI/180;
    const fx=0.5*vw/Math.tan(0.5*fov), fy=fx, cx=vw/2, cy=vh/2;
    detector.set_camera_info?.(fx,fy,cx,cy);

    const dets = await detector.detect(gray,vw,vh).catch(e=>{ msg('检测错误：'+e.message); return []; });
    const size=parseFloat(els.tagSize.value)||0.05;
    if(Array.isArray(dets)&&detector.set_tag_size){
      for(const d of dets){ detector.set_tag_size(d.id,size); }
    }
    draw(dets);
    requestAnimationFrame(loop);
  }

  els.start.addEventListener('click', async ()=>{
    try{
      els.start.disabled=true;
      await initDetector();
      await openCamera();
      running=true;
      msg('摄像头已开启，开始检测…');
      requestAnimationFrame(loop);
    }catch(e){
      msg('无法开启：'+e.message+'（请确认HTTPS并允许相机）');
      els.start.disabled=false;
    }
  });

  els.stop.addEventListener('click', ()=>{
    running=false; els.stop.disabled=true;
    if(stream) stream.getTracks().forEach(t=>t.stop());
    msg('已停止'); els.start.disabled=false;
  });
})();
</script>
</body>
</html>
