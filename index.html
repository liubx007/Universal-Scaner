<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>é€šç”¨æ‰«ç å™¨ï¼šQR / DataMatrix / AprilTag</title>
  <meta name="theme-color" content="#0b0b0c">
  <style>
    :root { --bg: #0b0b0c; --fg: #e8e8ea; --acc: #6ee7ff; --ok:#7dffb3; --warn:#ffd36e; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
    header { padding:12px 16px; border-bottom:1px solid #222; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    header h1 { font-size:18px; margin:0; font-weight:600; letter-spacing:.3px;}
    #controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-left:auto;}
    select,button,input[type=checkbox]+label { font-size:14px;}
    select,button { background:#16171a; color:var(--fg); border:1px solid #333; border-radius:10px; padding:8px 10px;}
    button:active { transform: translateY(1px); }
    main { display:grid; grid-template-columns: 1fr; gap:12px; padding:12px; }
    #stage { position:relative; border-radius:16px; overflow:hidden; background:#000; min-height: 40vh; }
    video { width:100%; height:auto; display:block; background:#000; }
    canvas.overlay { position:absolute; inset:0; pointer-events:none; }
    #log { background:#111; border:1px solid #222; border-radius:12px; padding:10px; max-height:35vh; overflow:auto; }
    .log-item { padding:8px; border-bottom:1px dashed #2a2a2a; }
    .log-item:last-child { border-bottom:none; }
    .tag { display:inline-block; font-size:12px; padding:2px 6px; border:1px solid #2a2a2a; border-radius:999px; margin-right:6px; }
    .tag.ok{ border-color: #244; color: var(--ok);}
    .tag.warn{ border-color: #442; color: var(--warn);}
    .badg { background:#1b1c20; padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a; font-size:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted{ color:#b8b8bb; }
    #status { font-size:13px; }
    footer{ padding:8px 12px; color:#9aa; font-size:12px; display:flex; justify-content:space-between; align-items:center;}
    #mask {
      position:absolute; inset:0; pointer-events:none;
      box-shadow: 0 0 0 100vmax rgba(0,0,0,.35);
      outline: 2px solid rgba(110,231,255,.7);
      outline-offset: -10px; border-radius: 16px;
      clip-path: inset(8% 6% 8% 6% round 16px);
    }
    a.btn { color:var(--fg); text-decoration:none; background:#16171a; border:1px solid #333; border-radius:10px; padding:8px 10px; }
    #perm {
      display:none; padding:10px; border:1px dashed #444; border-radius:10px; margin:0 12px;
      background:#111; color:#ddd; line-height:1.5;
    }
    #perm.show { display:block; }
  </style>
</head>
<body>
  <header>
    <h1>é€šç”¨æ‰«ç å™¨</h1>
    <div id="controls" class="row">
      <select id="camera"></select>
      <button id="torchBtn" aria-pressed="false" title="æ‰‹ç”µ/é—ªå…‰ç¯">ğŸ”¦ Torch</button>
      <button id="pauseBtn" aria-pressed="false">â¸ï¸ æš‚åœ</button>
      <label class="badg"><input id="apriltagToggle" type="checkbox" /> å¯ç”¨ AprilTag</label>
      <label class="badg">FPS
        <select id="fps">
          <option>15</option><option selected>24</option><option>30</option>
        </select>
      </label>
    </div>
  </header>

  <div id="perm" class="muted">
    ğŸ“· ç›¸æœºæœªå°±ç»ªã€‚è¯·ç¡®è®¤ï¼š1) å½“å‰æ˜¯ <b>HTTPS</b> é¡µé¢ï¼›2) æµè§ˆå™¨å·²å…è®¸â€œç›¸æœºâ€ï¼›3) è‹¥åœ¨ iPhoneï¼šåˆ° <b>è®¾ç½® â†’ Safari â†’ ç›¸æœº â†’ å…è®¸</b>ï¼›4) é‡æ–°åˆ·æ–°æœ¬é¡µå¹¶ç‚¹â€œå…è®¸â€ã€‚
  </div>

  <main>
    <section id="stage">
      <video id="video" playsinline muted autoplay></video>
      <div id="mask"></div>
      <canvas id="overlay" class="overlay"></canvas>
    </section>

    <section id="log">
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <strong>è¯†åˆ«ç»“æœ</strong>
        <span id="status" class="muted">ç›¸æœºåˆå§‹åŒ–ä¸­â€¦</span>
      </div>
      <div id="results"></div>
    </section>
  </main>

  <footer>
    <div>æ”¯æŒï¼š<span class="tag">QR</span><span class="tag">DataMatrix (ECC200)</span><span class="tag">AprilTag</span></div>
    <div class="muted">å»ºè®®åœ¨ HTTPS æˆ–æœ¬åœ°æœåŠ¡å™¨ä¸‹ä½¿ç”¨ï¼Œä»¥å¯ç”¨æ‘„åƒå¤´æƒé™</div>
  </footer>

  <!-- ZXing for QR/Data Matrix -->
  <script type="module">
    // ======= é…ç½® =======
    // é»˜è®¤å…ˆä¸å¯ç”¨ AprilTagï¼Œç­‰ç›¸æœºå·¥ä½œç¨³å®šåå†æ‰‹åŠ¨å‹¾é€‰ï¼ˆé¿å…é¦–æ¬¡åŠ è½½å¡é¡¿ï¼‰
    const ENABLE_APRILTAG_BY_DEFAULT = false;

    // å¯é€‰ï¼šå¤šä¸ª AprilTag wasm æºï¼ŒæŒ‰é¡ºåºå°è¯•
    const APRILTAG_SOURCES = [
      { js: "https://cdn.jsdelivr.net/npm/apriltag-js@0.1.6/dist/apriltag.js", wasm: "https://cdn.jsdelivr.net/npm/apriltag-js@0.1.6/dist/apriltag.wasm" },
      { js: "https://unpkg.com/apriltag-js@0.1.6/dist/apriltag.js", wasm: "https://unpkg.com/apriltag-js@0.1.6/dist/apriltag.wasm" },
      // { js: "./apriltag.js", wasm: "./apriltag.wasm" }, // è‹¥è¦ç¦»çº¿è‡ªæ‰˜ç®¡ï¼Œæ”¾åŒç›®å½•å¹¶å¯ç”¨æ­¤è¡Œ
    ];

    import { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } from "https://unpkg.com/@zxing/library@0.21.2/esm/index.js";

    // ======= å¼•ç”¨ =======
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d', { willReadFrequently: true });
    const cameraSel = document.getElementById('camera');
    const torchBtn = document.getElementById('torchBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const fpsSel = document.getElementById('fps');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const apriltagToggle = document.getElementById('apriltagToggle');
    const permEl = document.getElementById('perm');

    // ======= è¿è¡ŒçŠ¶æ€ =======
    let currentStream = null;
    let track = null;
    let reader;
    let running = true;
    let targetFPS = parseInt(fpsSel.value,10);
    let lastFrameTime = 0;

    // AprilTag
    let apriltagModule = null;
    let apriltagReady = false;

    // Torch/å¹³å°åˆ¤æ–­
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    let imageCapture = null;

    // ======= ZXing åˆå§‹åŒ–ï¼ˆä»… QR + DataMatrixï¼‰ =======
    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.QR_CODE, BarcodeFormat.DATA_MATRIX]);
    reader = new BrowserMultiFormatReader(hints, targetFPS);

    // ======= å·¥å…·å‡½æ•° =======
    function showStatus(t){ statusEl.textContent = t; }

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      cameraSel.innerHTML = "";
      cams.forEach((c,i) => {
        const opt = document.createElement('option');
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${i+1}`;
        cameraSel.appendChild(opt);
      });
      // ä¼˜å…ˆåç½®
      const preferred = cams.find(c=>/back|rear|environment/i.test(c.label))?.deviceId || cams[0]?.deviceId;
      if (preferred) cameraSel.value = preferred;
      if (!cams.length) throw new Error("æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡");
    }

    async function startCamera(deviceId) {
      // å…ˆåœæ­¢æ—§æµ
      if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
      const constraints = {
        audio:false,
        video:{
          deviceId: deviceId ? {exact: deviceId} : undefined,
          facingMode: deviceId ? undefined : { ideal: "environment" },
          width: { ideal: 1920 }, height: { ideal: 1080 },
          focusMode: "continuous" // ä¸€äº›æµè§ˆå™¨æ”¯æŒ
        }
      };
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = currentStream;
      // mobile autoplay éœ€è¦ muted + playsinlineï¼ˆæˆ‘ä»¬å·²è®¾ç½®ï¼‰
      await video.play();
      track = currentStream.getVideoTracks()[0];
      resizeCanvas();
      showStatus("ç›¸æœºå·²å°±ç»ª");
      permEl.classList.remove('show');
      await initTorch(track);
    }

    function resizeCanvas() {
      const rect = video.getBoundingClientRect();
      overlay.width = Math.max(1, rect.width * devicePixelRatio);
      overlay.height = Math.max(1, rect.height * devicePixelRatio);
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resizeCanvas);

    // ======= Torch æ¢æµ‹ä¸åˆ‡æ¢ï¼ˆiOS è‡ªåŠ¨éšè—ï¼‰ =======
    async function initTorch(track) {
      // iOS åŸºæœ¬ä¸æ”¯æŒ torchï¼šéšè—æŒ‰é’®
      if (isIOS) {
        torchBtn.style.display = 'none';
        return;
      }
      try {
        if ('ImageCapture' in window) {
          imageCapture = new ImageCapture(track);
          const photoCaps = await imageCapture.getPhotoCapabilities();
          if (photoCaps.fillLightMode?.includes?.('torch')) {
            torchBtn.disabled = false;
            return;
          }
        }
      } catch (e) {
        imageCapture = null;
      }
      const caps = track.getCapabilities?.() || {};
      if (caps.torch) {
        torchBtn.disabled = false;
      } else {
        torchBtn.style.display = 'none';
      }
    }

    async function toggleTorch() {
      if (!track) return;
      // ä¼˜å…ˆ ImageCapture
      if (imageCapture) {
        const pressed = torchBtn.getAttribute('aria-pressed') === 'true';
        try {
          await imageCapture.setOptions({ fillLightMode: pressed ? 'off' : 'torch' });
          torchBtn.setAttribute('aria-pressed', String(!pressed));
          return;
        } catch (e) {
          imageCapture = null; // å›é€€
        }
      }
      // å›é€€ applyConstraintsï¼ˆAndroid Chrome å¸¸è§æ”¯æŒï¼‰
      try {
        const pressed = torchBtn.getAttribute('aria-pressed') === 'true';
        await track.applyConstraints({ advanced: [{ torch: !pressed }] });
        torchBtn.setAttribute('aria-pressed', String(!pressed));
      } catch (e) {
        console.warn('Torch not supported:', e);
      }
    }

    // ======= AprilTag WASM åŠ è½½ï¼ˆæŒ‰å€™é€‰æºï¼‰ =======
    async function loadAprilTag() {
      for (const src of APRILTAG_SOURCES) {
        try {
          const modFactory = await import(/* @vite-ignore */ src.js);
          apriltagModule = await modFactory.default({
            locateFile: (p) => p.endsWith(".wasm") ? src.wasm : p
          });
          apriltagReady = true;
          showStatus("AprilTag å°±ç»ª");
          return;
        } catch (e) {
          console.warn("AprilTag æ¥æºä¸å¯ç”¨ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªï¼š", src, e);
        }
      }
      apriltagReady = false;
      showStatus("AprilTag æœªå¯ç”¨ï¼ˆä»… QR/DataMatrixï¼‰");
    }

    // ======= ç»“æœæ—¥å¿— =======
    function addResult(type, text) {
      const div = document.createElement('div');
      div.className = 'log-item';
      const tag = document.createElement('span');
      tag.className = 'tag ok';
      tag.textContent = type;
      const pre = document.createElement('div');
      pre.style.whiteSpace = 'pre-wrap';
      pre.textContent = text;
      div.appendChild(tag);
      div.appendChild(pre);
      resultsEl.prepend(div);
    }

    // ======= è§£ç å¾ªç¯ =======
    async function decodeBarcodes() {
      try {
        const result = await reader.decodeOnceFromVideoElement(video);
        if (result?.text) {
          addResult(result.getBarcodeFormat(), result.text);
        }
      } catch (e) {
        // å¿½ç•¥ timeout
      }
    }

    function detectAprilTags() {
      if (!apriltagReady) return;
      try {
        const w = video.videoWidth, h = video.videoHeight;
        if (!w || !h) return;
        ctx.drawImage(video, 0, 0, overlay.width/devicePixelRatio, overlay.height/devicePixelRatio);
        const img = ctx.getImageData(0, 0, w, h);
        const gray = new Uint8Array(w*h);
        for (let i=0, j=0; i<img.data.length; i+=4, j++) {
          const r=img.data[i], g=img.data[i+1], b=img.data[i+2];
          gray[j] = (r*0.299 + g*0.587 + b*0.114)|0;
        }
        const t0 = performance.now();
        const detections = apriltagModule.detect(gray, w, h, { family: "tag36h11" });
        const t1 = performance.now();
        if (detections && detections.length) {
          detections.forEach(det => {
            addResult("AprilTag", `id=${det.id}  fam=${det.family}  hamming=${det.hamming}  margin=${det.decision_margin?.toFixed?.(1) ?? ""}  ${(t1-t0).toFixed(1)}ms`);
          });
        }
      } catch (e) {
        console.warn("AprilTag detect error:", e);
      }
    }

    function loop(ts) {
      if (!running) { requestAnimationFrame(loop); return; }
      const dt = ts - lastFrameTime;
      const budget = 1000/targetFPS;
      if (dt >= budget) {
        lastFrameTime = ts;
        // æ¸…ç† overlay
        ctx.clearRect(0,0,overlay.width, overlay.height);
        // æŠ½å¸§è¯†åˆ«
        decodeBarcodes();
        if (apriltagToggle.checked) detectAprilTags();
      }
      requestAnimationFrame(loop);
    }

    // ======= äº‹ä»¶ =======
    cameraSel.addEventListener('change', ()=> startCamera(cameraSel.value).catch(err=>showFail(err)));
    torchBtn.addEventListener('click', toggleTorch);
    pauseBtn.addEventListener('click', ()=>{
      running = !running;
      pauseBtn.setAttribute('aria-pressed', String(!running));
      pauseBtn.textContent = running ? "â¸ï¸ æš‚åœ" : "â–¶ï¸ ç»§ç»­";
      showStatus(running ? "æ‰«æä¸­â€¦" : "å·²æš‚åœ");
    });
    fpsSel.addEventListener('change', ()=> {
      targetFPS = parseInt(fpsSel.value,10);
      showStatus(`FPS=${targetFPS}`);
    });
    apriltagToggle.addEventListener('change', ()=>{
      if (apriltagToggle.checked && !apriltagReady) {
        showStatus("åŠ è½½ AprilTagâ€¦");
        loadAprilTag();
      }
    });

    function showFail(err){
      console.error(err);
      showStatus(err?.message || String(err));
      permEl.classList.add('show');
    }

    // ======= å¯åŠ¨ =======
    (async function boot() {
      try {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          console.warn("é HTTPSï¼Œå¯èƒ½æ‹¿ä¸åˆ°æ‘„åƒå¤´æƒé™");
        }
        apriltagToggle.checked = ENABLE_APRILTAG_BY_DEFAULT;
        await listCameras();
        await startCamera(cameraSel.value);
        showStatus("æ‰«æä¸­â€¦");
        resizeCanvas();
        requestAnimationFrame(loop);
        if (apriltagToggle.checked) {
          showStatus("åŠ è½½ AprilTagâ€¦");
          await loadAprilTag();
          showStatus(apriltagReady ? "AprilTag å°±ç»ªï¼Œæ‰«æä¸­â€¦" : "AprilTag æœªå¯ç”¨ï¼ˆä»… QR/DataMatrixï¼‰");
        }
      } catch (e) {
        showFail(e);
      }
    })();
  </script>
</body>
</html>
