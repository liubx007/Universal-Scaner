<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>é€šç”¨æ‰«ç å™¨ï¼šQR / DataMatrix / AprilTag</title>
  <style>
    :root { --bg: #0b0b0c; --fg: #e8e8ea; --acc: #6ee7ff; --ok:#7dffb3; --warn:#ffd36e; --mut:#9aa;}
    html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
    header { padding:12px 16px; border-bottom:1px solid #222; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    header h1 { font-size:18px; margin:0; font-weight:600; letter-spacing:.3px;}
    #controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-left:auto;}
    select,button,input[type=checkbox]+label { font-size:14px;}
    select,button { background:#16171a; color:var(--fg); border:1px solid #333; border-radius:10px; padding:8px 10px;}
    button:active { transform: translateY(1px); }
    main { display:grid; grid-template-columns: 1fr; gap:12px; padding:12px; }
    #stage { position:relative; border-radius:16px; overflow:hidden; background:#000; }
    video { width:100%; height:auto; display:block; background:#000; }
    canvas.overlay { position:absolute; inset:0; pointer-events:none; }
    #log { background:#111; border:1px solid #222; border-radius:12px; padding:10px; max-height:30vh; overflow:auto; }
    .log-item { padding:8px; border-bottom:1px dashed #2a2a2a; }
    .log-item:last-child { border-bottom:none; }
    .tag { display:inline-block; font-size:12px; padding:2px 6px; border:1px solid #2a2a2a; border-radius:999px; margin-right:6px; }
    .tag.ok{ border-color: #244; color: var(--ok);}
    .tag.warn{ border-color: #442; color: var(--warn);}
    .badg { background:#1b1c20; padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a; font-size:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted{ color:#b8b8bb; }
    #status { font-size:13px; }
    footer{ padding:8px 12px; color:#9aa; font-size:12px; display:flex; justify-content:space-between; align-items:center;}
    #mask {
      position:absolute; inset:0; pointer-events:none;
      box-shadow: 0 0 0 100vmax rgba(0,0,0,.35);
      outline: 2px solid rgba(110,231,255,.7);
      outline-offset: -10px; border-radius: 16px;
      clip-path: inset(8% 6% 8% 6% round 16px);
    }
    details { background:#0f1013; border:1px solid #222; border-radius:10px; padding:8px 10px;}
    summary{ cursor:pointer; color:var(--mut); }
    pre{ white-space:pre-wrap; word-break:break-word; font-family:ui-monospace,Consolas,monospace; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>é€šç”¨æ‰«ç å™¨</h1>
    <div id="controls" class="row">
      <select id="camera"></select>
      <button id="startBtn">â–¶ï¸ å¯åŠ¨</button>
      <button id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
      <button id="torchBtn" aria-pressed="false" title="æ‰‹ç”µ/é—ªå…‰ç¯" disabled>ğŸ”¦ Torch</button>
      <label class="badg"><input id="apriltagToggle" type="checkbox" /> å¯ç”¨ AprilTag</label>
      <label class="badg">FPS
        <select id="fps">
          <option>15</option><option selected>24</option><option>30</option>
        </select>
      </label>
    </div>
  </header>

  <main>
    <section id="stage">
      <video id="video" playsinline muted></video>
      <div id="mask"></div>
      <canvas id="overlay" class="overlay"></canvas>
    </section>

    <section id="log">
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <strong>è¯†åˆ«ç»“æœ</strong>
        <span id="status" class="muted">è¯·ç‚¹å‡»â€œå¯åŠ¨â€å¹¶å…è®¸ç›¸æœºæƒé™</span>
      </div>
      <div id="results"></div>
    </section>

    <details>
      <summary>è¯Šæ–­ä¿¡æ¯ï¼ˆå±•å¼€æŸ¥çœ‹ï¼‰</summary>
      <div class="row" style="gap:16px; margin:8px 0;">
        <div>åè®®ï¼š<code id="proto"></code></div>
        <div>åŸŸåï¼š<code id="host"></code></div>
        <div>UAï¼š<code id="ua"></code></div>
      </div>
      <pre id="diag"></pre>
    </details>
  </main>

  <footer>
    <div>æ”¯æŒï¼š<span class="tag">QR</span><span class="tag">DataMatrix (ECC200)</span><span class="tag">AprilTagï¼ˆå¯é€‰ï¼‰</span></div>
    <div class="muted">å»ºè®®åœ¨ HTTPS æˆ– localhost ä¸‹ä½¿ç”¨ï¼Œä¿éšœæ‘„åƒå¤´æƒé™</div>
  </footer>

  <!-- ZXing for QR/Data Matrix -->
  <script type="module">
    // ======= AprilTag CDN åˆ—è¡¨ï¼ˆæŒ‰é¡ºåºå°è¯•ï¼‰ã€‚ä¹Ÿå¯æ”¹ä¸º ./apriltag.{js,wasm} æœ¬åœ°æ–‡ä»¶ =======
    const APRILTAG_SOURCES = [
      { js: "https://cdn.jsdelivr.net/npm/apriltag-js@0.1.6/dist/apriltag.js", wasm: "https://cdn.jsdelivr.net/npm/apriltag-js@0.1.6/dist/apriltag.wasm" },
      { js: "https://unpkg.com/apriltag-js@0.1.6/dist/apriltag.js", wasm: "https://unpkg.com/apriltag-js@0.1.6/dist/apriltag.wasm" },
      // { js: "./apriltag.js", wasm: "./apriltag.wasm" },
    ];

    import { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } from "https://unpkg.com/@zxing/library@0.21.2/esm/index.js";

    // ======= å¼•ç”¨ =======
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d', { willReadFrequently: true });
    const cameraSel = document.getElementById('camera');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const torchBtn = document.getElementById('torchBtn');
    const pauseBtn = null;
    const fpsSel = document.getElementById('fps');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const apriltagToggle = document.getElementById('apriltagToggle');
    const diag = document.getElementById('diag');
    const protoEl = document.getElementById('proto');
    const hostEl = document.getElementById('host');
    const uaEl = document.getElementById('ua');

    protoEl.textContent = location.protocol;
    hostEl.textContent = location.host;
    uaEl.textContent = navigator.userAgent;

    // ======= çŠ¶æ€ =======
    let currentStream = null;
    let track = null;
    let reader;
    let running = false;
    let targetFPS = parseInt(fpsSel.value,10);
    let lastFrameTime = 0;

    // AprilTag
    let apriltagModule = null;
    let apriltagReady = false;

    // ======= ZXing åˆå§‹åŒ–ï¼ˆä»… QR + DataMatrixï¼‰ =======
    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.QR_CODE, BarcodeFormat.DATA_MATRIX]);
    reader = new BrowserMultiFormatReader(hints, targetFPS);

    // ======= å®ç”¨å‡½æ•° =======
    function logDiag(...args){
      const line = args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ');
      diag.textContent = line + "\\n" + diag.textContent;
      console.log(...args);
    }

    async function listCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        cameraSel.innerHTML = "";
        cams.forEach((c,i) => {
          const opt = document.createElement('option');
          opt.value = c.deviceId;
          opt.textContent = c.label || `Camera ${i+1}`;
          cameraSel.appendChild(opt);
        });
        const preferred = cams.find(c=>/back|rear|environment/i.test(c.label))?.deviceId || cams[0]?.deviceId;
        if (preferred) cameraSel.value = preferred;
        logDiag("enumerateDevices:", devices);
      } catch(e){
        logDiag("enumerateDevices error:", e.name, e.message);
      }
    }

    function resizeCanvas() {
      const rect = video.getBoundingClientRect();
      overlay.width = rect.width * devicePixelRatio;
      overlay.height = rect.height * devicePixelRatio;
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resizeCanvas);

    async function toggleTorch() {
      if (!track) return;
      try {
        const caps = track.getCapabilities?.() || {};
        if (!caps.torch) throw new Error("è®¾å¤‡ä¸æ”¯æŒ torch");
        const pressed = torchBtn.getAttribute('aria-pressed') === 'true';
        await track.applyConstraints({ advanced: [{ torch: !pressed }] });
        torchBtn.setAttribute('aria-pressed', String(!pressed));
        torchBtn.textContent = !pressed ? "ğŸ”¦ Torchï¼ˆå¼€ï¼‰" : "ğŸ”¦ Torch";
      } catch(e) {
        logDiag("torch error:", e.name || "", e.message || e);
        alert("Torch å¤±è´¥ï¼š" + (e.message || e));
      }
    }

    async function startCamera(deviceId) {
      if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
      const constraints = {
        audio:false,
        video:{
          deviceId: deviceId ? {exact: deviceId} : undefined,
          facingMode: deviceId ? undefined : { ideal: "environment" },
          width: { ideal: 1280 }, height: { ideal: 720 }
        }
      };
      statusEl.textContent = "è¯·æ±‚ç›¸æœºæƒé™â€¦";
      const st = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = st;
      video.srcObject = currentStream;
      await video.play();
      track = currentStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      const settings = track.getSettings?.() || {};
      logDiag("getUserMedia OK. constraints=", constraints);
      logDiag("track.capabilities=", caps);
      logDiag("track.settings=", settings);
      resizeCanvas();
      statusEl.textContent = "ç›¸æœºå·²å°±ç»ª";
      torchBtn.disabled = !caps.torch;
      stopBtn.disabled = false;
      running = true;
      requestAnimationFrame(loop);
    }

    function stopCamera() {
      try{ currentStream?.getTracks().forEach(t=>t.stop()); }catch{}
      currentStream = null;
      track = null;
      running = false;
      video.srcObject = null;
      stopBtn.disabled = true;
      torchBtn.disabled = true;
      statusEl.textContent = "å·²åœæ­¢";
    }

    // ======= AprilTag WASM æ‡’åŠ è½½ï¼ˆä¸é˜»å¡ç›¸æœºï¼‰ =======
    async function loadAprilTag() {
      for (const src of APRILTAG_SOURCES) {
        try {
          const modFactory = await import(/* @vite-ignore */ src.js);
          apriltagModule = await modFactory.default({ locateFile: (p)=> p.endsWith(".wasm") ? src.wasm : p });
          apriltagReady = true;
          statusEl.textContent = "AprilTag å°±ç»ª";
          logDiag("AprilTag loaded:", src.js);
          return;
        } catch(e) {
          logDiag("AprilTag æ¥æºä¸å¯ç”¨ï¼š", src, e.message || e);
        }
      }
      apriltagReady = false;
      statusEl.textContent = "AprilTag æœªå¯ç”¨ï¼ˆä»… QR/DataMatrixï¼‰";
    }

    function addResult(type, text) {
      const div = document.createElement('div');
      div.className = 'log-item';
      const tag = document.createElement('span');
      tag.className = 'tag ok';
      tag.textContent = type;
      const pre = document.createElement('div');
      pre.style.whiteSpace = 'pre-wrap';
      pre.textContent = text;
      div.appendChild(tag);
      div.appendChild(pre);
      resultsEl.prepend(div);
    }

    async function decodeBarcodes() {
      try {
        const result = await reader.decodeOnceFromVideoElement(video);
        if (result?.text) addResult(result.getBarcodeFormat(), result.text);
      } catch {}
    }

    function detectAprilTags() {
      if (!apriltagReady || !apriltagToggle.checked) return;
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) return;
      ctx.drawImage(video, 0, 0, overlay.width/devicePixelRatio, overlay.height/devicePixelRatio);
      const img = ctx.getImageData(0, 0, w, h);
      const gray = new Uint8Array(w*h);
      for (let i=0, j=0; i<img.data.length; i+=4, j++) {
        const r=img.data[i], g=img.data[i+1], b=img.data[i+2];
        gray[j] = (r*0.299 + g*0.587 + b*0.114)|0;
      }
      const t0 = performance.now();
      const dets = apriltagModule.detect(gray, w, h, { family: "tag36h11" });
      const t1 = performance.now();
      if (dets && dets.length) {
        dets.forEach(det => addResult("AprilTag", `id=${det.id}  fam=${det.family}  hamming=${det.hamming}  margin=${det.decision_margin?.toFixed?.(1) ?? ""}  ${(t1-t0).toFixed(1)}ms`));
      }
    }

    function loop(ts) {
      if (!running) return;
      const dt = ts - lastFrameTime;
      const budget = 1000/targetFPS;
      if (dt >= budget) {
        lastFrameTime = ts;
        ctx.clearRect(0,0,overlay.width, overlay.height);
        decodeBarcodes();
        detectAprilTags();
      }
      requestAnimationFrame(loop);
    }

    // ======= äº‹ä»¶ =======
    cameraSel.addEventListener('change', ()=> startCamera(cameraSel.value).catch(e=>{ statusEl.textContent = e?.name || "å¯åŠ¨å¤±è´¥"; logDiag("startCamera error:", e.name, e.message); }));
    startBtn.addEventListener('click', async ()=>{
      try {
        // å…ˆåˆ—è®¾å¤‡ï¼ˆæˆæƒå‰ label å¯èƒ½ä¸ºç©ºï¼‰
        await listCameras();
        await startCamera(cameraSel.value);
      } catch(e){
        statusEl.textContent = e?.name || "å¯åŠ¨å¤±è´¥";
        logDiag("start error:", e.name, e.message);
        alert("å¯åŠ¨å¤±è´¥ï¼š" + (e.message || e));
      }
    });
    stopBtn.addEventListener('click', stopCamera);
    torchBtn.addEventListener('click', toggleTorch);
    fpsSel.addEventListener('change', ()=> {
      targetFPS = parseInt(fpsSel.value,10);
      statusEl.textContent = `FPS=${targetFPS}`;
    });
    apriltagToggle.addEventListener('change', ()=>{
      if (apriltagToggle.checked && !apriltagReady) {
        statusEl.textContent = "åŠ è½½ AprilTagâ€¦";
        loadAprilTag();
      }
    });

    // ======= é¦–æ¬¡è¿›å…¥ï¼šæç¤º HTTPSï¼Œå¹¶å°è¯•åˆ—è®¾å¤‡ =======
    (async function boot(){
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        statusEl.textContent = "æç¤ºï¼šè¯·åœ¨ HTTPS æˆ– localhost ä¸‹ä½¿ç”¨ï¼ˆå¦åˆ™ç›¸æœºæƒé™å¯èƒ½è¢«æ‹’ï¼‰";
        logDiag("åè®®è­¦å‘Šï¼š", location.protocol);
      }
      await listCameras();
    })();
  </script>
</body>
</html>
